#!/usr/bin/env python3
"""Edit a file in the host nvim instance."""
from __future__ import print_function
import os
import sys

from neovim import attach

addr = os.environ.get("NVIM_LISTEN_ADDRESS", None)
args = sys.argv[1:]
if not addr:
    if sys.argv[0].endswith('/sp'):
        args = ['nvim', '-o'] + args
    elif sys.argv[0].endswith('/vs'):
        args = ['nvim', '-O'] + args
    else:
        args = ['nvim'] + args
    os.execvp('nvim', args)

nvim = attach("socket", path=addr)

try:
    nvim.vars['files_to_edit'] = list(map(os.path.abspath, args))
    if sys.argv[0].endswith('/sp'):
        command = 'new' if not args else 'sp'
    elif sys.argv[0].endswith('/vs'):
        command = 'vnew' if not args else 'vs'
    else:
        command = 'enew' if not args else 'e'
    for x in range(0, len(args)):
        nvim.command('exe "' + command + ' " . fnameescape(remove(g:files_to_edit, 0))')
finally:
    nvim.vars['files_to_edit'] = None
    nvim.stop_loop()

